<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BookHook</title>

<style>
/* === Deck (one card on screen; next ones stacked) === */
.deck{ position:relative; height:440px; overflow:visible }
@media (max-width:760px){ .deck{ height:520px } }

.deck .card {
  position:absolute; inset:0;
  display:grid; grid-template-columns:190px 1fr; gap:16px;
  background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px;
  box-shadow:0 10px 24px rgba(0,0,0,.08);
  will-change:transform; touch-action:pan-y; user-select:none;
  contain:layout paint; backface-visibility:hidden; transform:translateZ(0);
}
@media (max-width:760px){ .deck .card{ grid-template-columns:1fr } }

.deck .card:nth-child(1){ z-index:3 }
.deck .card:nth-child(2){ z-index:2; transform:translateY(8px) scale(.992); opacity:.9 }
.deck .card:nth-child(3){ z-index:1; transform:translateY(16px) scale(.985); opacity:.8 }

.badge-swipe{position:absolute;top:10px;padding:6px 10px;border-radius:8px;font-weight:700;border:2px solid;background:rgba(255,255,255,.9);opacity:0;transition:opacity .12s;pointer-events:none}
.badge-swipe.like{left:10px;color:#0a6a0a;border-color:#0a6a0a}
.badge-swipe.nope{right:10px;color:#cc1b1b;border-color:#cc1b1b}

.cover{width:100%;aspect-ratio:2/3;border-radius:12px;overflow:hidden;background:#e9eef3;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:40px}
.cover img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none;-webkit-user-drag:none}

.title{margin:6px 0 4px;font-size:22px;line-height:1.25;font-weight:800}
.chips{display:flex;gap:8px;margin:6px 0 10px;align-items:center;overflow-x:auto;padding-bottom:2px;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{display:inline-flex;white-space:nowrap;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fafafa;font-size:13px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  /* —— Base ——————————————————————————————— */
:root{
  --bg:#f7f7f8; --fg:#111; --muted:#6b7280;
  --card:#fff; --line:#e5e7eb; --pill:#f5f5f5;
  --gold:#E7C200;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);
  font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:980px;margin:0 auto;padding:18px 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 8px rgba(0,0,0,.04)}
h1,h2{margin:0 0 10px}
.muted{color:var(--muted);font-size:14px}
.btn{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
.btn.small{font-size:12px;padding:6px 10px}
.badge{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:600;font-size:12px}
.badge.gold{background:#fff7cc;border-color:var(--gold)}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0}
.field{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
.pills{display:flex;flex-wrap:wrap;gap:8px}
.pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--pill);cursor:pointer}
.pill.on{background:#111;color:#fff;border-color:#111}

/* —— Top bar (centered) ——————————————————— */
.topbar{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid var(--line)}
.topbar .nav{display:flex;justify-content:center;gap:10px;padding:10px 0;flex-wrap:wrap}
.topbar .status{position:absolute;right:14px;top:10px}

/* —— Hero (center logo) ——————————————————— */
.hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 12px}
.logo{height:56px}
.logoText{font-weight:800}

/* —— Hints row ——————————————————————————— */
.hintbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:-4px 0 10px}
.hint-pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:600;font-size:12px;color:#444}

/* —— Discover: carousel + cards ——————————— */
.
@media (max-width:760px){.card-gesture{min-width:92vw;grid-template-columns:1fr}}

.cover{width:100%;aspect-ratio:2/3;border-radius:12px;overflow:hidden;background:#e9eef3;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:40px}
.cover img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none;-webkit-user-drag:none}

.title{margin:6px 0 4px;font-size:22px;line-height:1.25;font-weight:800}
.chips{display:flex;gap:8px;margin:6px 0 10px;align-items:center;overflow-x:auto;padding-bottom:2px;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{display:inline-flex;white-space:nowrap;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fafafa;font-size:13px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

.badge-swipe{position:absolute;top:10px;padding:6px 10px;border-radius:8px;font-weight:700;border:2px solid;background:rgba(255,255,255,.9);opacity:0;transition:opacity .12s;pointer-events:none}
.badge-swipe.like{left:10px;color:#0a6a0a;border-color:#0a6a0a}
.badge-swipe.nope{right:10px;color:#cc1b1b;border-color:#cc1b1b}

/* —— Edge nav zones (browse-only; no save) —— */
.navZone { position:absolute; top:0; bottom:0; width:16%; z-index:2; }
.navZone.left  { left:0; }
.navZone.right { right:0; }
.navHint{
  position:absolute; top:50%; transform:translateY(-50%);
  background:#fff; border:1px solid var(--line); border-radius:999px;
  padding:6px 10px; font-weight:700; font-size:12px; opacity:.9; pointer-events:none;
}
.navHint.left { left:8px } .navHint.right { right:8px }

/* —— Shelf mini list ———————————————————— */
.list{display:flex;flex-direction:column;gap:10px}
.tile{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff}
.thumb{width:64px;height:96px;border-radius:8px;background:#eee;overflow:hidden}
.thumb img{width:100%;height:100%;object-fit:cover}
.stat{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#f6f6f6;font-size:12px}
.stat.want{background:#eef3ff;border-color:#cfe1ff}
.stat.reading{background:#eaf8ed;border-color:#b8e4c3}
.stat.read{background:#fff0d2;border-color:#f7dc8a}
  /* ==== Discover: card deck (not a carousel) ==== */
.deck{ position:relative; height:auto; min-height:340px; }
.deck .card-gesture{
  position:absolute; inset:auto 0 0 0;
  margin:0;
  transform-origin:50% 90%;
  will-change:transform;
  touch-action:pan-y;
  contain:layout paint;
  backface-visibility:hidden;
}
.deck .card-gesture:nth-child(1){ z-index:3; }
.deck .card-gesture:nth-child(2){ z-index:2; transform:scale(.98) translateY(6px); opacity:.98 }
.deck .card-gesture:nth-child(3){ z-index:1; transform:scale(.96) translateY(12px); opacity:.95 }
.deck .card-gesture:nth-child(n+4){ display:none; }

.badge-swipe{ pointer-events:none; }        /* labels don’t block drags */
.cover img{ pointer-events:none; -webkit-user-drag:none; }
</style>
</head>

<body>
<!-- —— Top bar —— -->
<div class="topbar">
  <div class="nav">
    <button class="btn small" onclick="scrollToId('discoverSection')">Discover</button>
    <button class="btn small" onclick="scrollToId('hookmarks')">HookMarks</button>
    <button class="btn small" onclick="scrollToId('profile')">My Profile</button>
    <button class="btn small" onclick="scrollToId('boards')">Leaderboards</button>
  </div>
  <div class="status"><span class="badge">Bronze</span> <span id="pts" class="badge gold">0 pts</span></div>
</div>

<main class="wrap">
  <!-- —— Hero —— -->
  <section class="hero">
    <!-- Simple black book logo with hook (no text baked in) -->
<!-- Open black book + hook-arrows (no text baked in) -->
<!-- ORIGINAL simple black logo (rounded square + white “hook hole”) -->
<svg class="logo" viewBox="0 0 64 64" width="56" height="56" aria-label="BookHook">
  <rect x="8" y="8" width="48" height="48" rx="12" fill="#000"/>
  <circle cx="26" cy="26" r="10" fill="#fff"/>
</svg>
    <div class="logoText">BookHook</div>
  </section>

  <!-- —— Feeling —— -->
  <section class="card">
    <h2>How I'm feeling</h2>
    <div class="row">
      <input id="moodFree" class="field" placeholder="Type how you feel… (e.g. anxious, excited, pumped)" />
      <button id="setMoodFree" class="btn small">Set</button>
    </div>
    <div class="row">
      <div class="pills">
        <button class="pill" onclick="setLevel('Low')">Low</button>
        <button class="pill" onclick="setLevel('Medium')">Medium</button>
        <button class="pill" onclick="setLevel('High')">High</button>
      </div>
    </div>
    <div class="muted">Your vibe nudges the matches below.</div>
  </section>

  <!-- —— Desired Mood (grouped) —— -->
 <section class="card" id="desired">
  <h2>Desired Mood</h2>
  <div id="desiredTabs" class="row"></div>
  <div id="desiredPills" class="pills"></div>
  <div class="muted">Choose a few — these steer the match score below.</div>
</section>

  <!-- —— Discover —— -->
  <section class="card" id="discoverSection">
  <h2>Discover</h2>
  <div class="hintbar">
    <span class="hint-pill">Swipe left → Want</span>
    <span class="hint-pill">Swipe right → Reading</span>
    <span class="hint-pill">Tap “Already read” to add HookMarks</span>
  </div>
  <!-- Deck renderer puts 1–3 stacked cards here -->
  <div id="deck" class="deck"></div>
</section>

  <!-- —— Shelf —— -->
  <section class="card" id="shelf">
    <h2>Your Shelf</h2>
    <div class="muted">Save or swipe to add books. Full shelf appears in My Profile.</div>
    <div id="shelfList" class="list"></div>
  </section>

  <!-- —— HookMarks (placeholder) —— -->
  <section class="card" id="hookmarks">
    <h2>HookMarks</h2>
    <div class="muted">Add when you mark “Already read”.</div>
  </section>

  <!-- —— Profile —— -->
  <section class="card" id="profile">
    <h2>My Profile</h2>
    <div class="row"><span class="badge">Role</span>
      <label class="pill"><input type="checkbox" id="isReader" checked /> Reader</label>
      <label class="pill"><input type="checkbox" id="isAuthor" /> Author</label>
    </div>
    <div class="row"><span class="badge">Points</span> <b id="profilePts">0</b></div>
  </section>

  <!-- —— Boards —— -->
  <section class="card" id="boards">
    <h2>Leaderboards</h2>
    <div class="muted">Coming next.</div>
  </section>
</main>

<script>
/* ============ State ============ */
const state = {
  moodNowLevel:null,
  desired:new Set(),
  pts:Number(localStorage.getItem('bh_pts')||0),
  shelf: JSON.parse(localStorage.getItem('bh_shelf')||"[]"),
  order:[]
};
/* === Desired Mood data & UI === */
const MOOD_GROUPS = {
  "Calm / Steady": ["Calm","Restful","Reflective","Grounding","Peaceful","Soothing"],
  "Clarity":       ["Clear-headed","Focused","Insightful","Mindset-shifting"],
  "Drive":         ["Motivated","Empowered","Productive","Entrepreneurial"],
  "Spark / Fun":   ["Playful","Silly","Comedic","Uplifting","Inspiring","Arousing"],
  "Comfort & Care":["Comforted","Self-loving","Grateful","Connected"]
};
let activeGroup = Object.keys(MOOD_GROUPS)[0];

function renderDesiredTabs(){
  document.getElementById('desiredTabs').innerHTML =
    Object.keys(MOOD_GROUPS).map(g =>
      `<button class="pill ${g===activeGroup?'on':''}" onclick="setDesiredGroup('${g}')">${g}</button>`
    ).join('');
}
function setDesiredGroup(g){
  activeGroup = g; renderDesiredTabs(); renderDesiredPills(); refreshMatches();
}
function renderDesiredPills(){
  const items = MOOD_GROUPS[activeGroup];
  document.getElementById('desiredPills').innerHTML =
    items.map(n => `<button class="pill ${state.desired.has(n)?'on':''}" onclick="toggleDesired('${n}')">${n}</button>`).join('');
}
function toggleDesired(n){
  state.desired.has(n) ? state.desired.delete(n) : state.desired.add(n);
  renderDesiredPills(); refreshMatches();
}
/* ============ Desired Mood groups (with Entrepreneurial) ============ */
const MOOD_GROUPS = {
  "Calm / Steady": ["Calm","Restful","Reflective","Grounding","Peaceful","Soothing"],
  "Clarity": ["Clear-headed","Focused","Insightful","Mindset-shifting"],
  "Drive": ["Motivated","Empowered","Productive","Entrepreneurial"],
  "Spark / Fun": ["Playful","Silly","Comedic","Uplifting","Inspiring","Arousing"],
  "Comfort & Care": ["Comforted","Self-loving","Grateful","Connected"]
};
let activeGroup = Object.keys(MOOD_GROUPS)[0];

const MOOD_MAP = {
  low:["sad","down","tired","drained","anxious","overwhelmed","lonely","stressed","meh"],
  medium:["ok","fine","neutral","calm","grounded","chill","steady"],
  high:["happy","joyful","excited","energized","pumped","hyped","curious","inspired","motivated"]
};

/* ============ Books ============ */
const BOOKS = [
  { id:"rid", title:"The Ridiculous: Book 1", author:"Jef & Mindy",
    vibes:["Funny","Satirical","Empowering","Chill","Feel-good"],
    facts:{pace:"Medium", pages:312, year:2024}, gold:true, links:{site:"#", buy:"#"} },

  { id:"mag", title:"Magical Adventures of Lori & Bonnie B. Bunny", author:"Elaine Blackstien",
    vibes:["Inspiring","Playful","Comedic","Uplifting","Fast"],
    facts:{pace:"Fast", pages:248, year:2025}, links:{buy:"#"} },

  { id:"phm", title:"Project Hail Mary", author:"Andy Weir",
    vibes:["Adventurous","Ingenious","Page-turner","Uplifting"],
    facts:{pace:"Fast", pages:496, year:2021} },

  { id:"mart", title:"The Martian", author:"Andy Weir",
    vibes:["Funny","Ingenious","Survival","Hopeful"],
    facts:{pace:"Fast", pages:387, year:2014} },

  { id:"alc", title:"The Alchemist", author:"Paulo Coelho",
    vibes:["Reflective","Spiritual","Inspiring","Uplifting"],
    facts:{pace:"Medium", pages:208, year:1988} },

  { id:"power", title:"The Power of Now", author:"Eckhart Tolle",
    vibes:["Calm","Mindful","Grounding","Insightful"],
    facts:{pace:"Slow", pages:236, year:1997} },

  { id:"edu", title:"Educated", author:"Tara Westover",
    vibes:["Powerful","Moving","Reflective","Transformative"],
    facts:{pace:"Medium", pages:352, year:2018} },

  { id:"becoming", title:"Becoming", author:"Michelle Obama",
    vibes:["Inspiring","Warm","Reflective","Personal"],
    facts:{pace:"Medium", pages:448, year:2018} },

  { id:"crawdads", title:"Where the Crawdads Sing", author:"Delia Owens",
    vibes:["Evocative","Romantic","Mysterious","Immersive"],
    facts:{pace:"Medium", pages:384, year:2018} },

  { id:"nowhab", title:"Atomic Habits", author:"James Clear",
    vibes:["Practical","Motivating","Focused","Productive"],
    facts:{pace:"Fast", pages:320, year:2018} }
];

/* ============ Helpers ============ */
const $ = s => document.querySelector(s);
function scrollToId(id){ document.getElementById(id)?.scrollIntoView({behavior:'smooth'}); }
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, m => (
    {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]
  ));
}
function addPts(n){ state.pts+=n; localStorage.setItem('bh_pts',state.pts); $('#pts').textContent=state.pts+' pts'; $('#profilePts').textContent=state.pts; }

/* ============ Feeling ============ */
  function refreshMatches(){
  state.order = [...BOOKS].sort((a,b)=>score(b)-score(a));
  renderDeck();
}
/* === Desired Mood data & UI === */
const MOOD_GROUPS = {
  "Calm / Steady": ["Calm","Restful","Reflective","Grounding","Peaceful","Soothing"],
  "Clarity":       ["Clear-headed","Focused","Insightful","Mindset-shifting"],
  "Drive":         ["Motivated","Empowered","Productive","Entrepreneurial"],
  "Spark / Fun":   ["Playful","Silly","Comedic","Uplifting","Inspiring","Arousing"],
  "Comfort & Care":["Comforted","Self-loving","Grateful","Connected"]
};
let activeGroup = Object.keys(MOOD_GROUPS)[0];

function renderDesiredTabs(){
  document.getElementById('desiredTabs').innerHTML =
    Object.keys(MOOD_GROUPS).map(g =>
      `<button class="pill ${g===activeGroup?'on':''}" onclick="setDesiredGroup('${g}')">${g}</button>`
    ).join('');
}
function setDesiredGroup(g){
  activeGroup = g; renderDesiredTabs(); renderDesiredPills(); refreshMatches();
}
function renderDesiredPills(){
  const items = MOOD_GROUPS[activeGroup];
  document.getElementById('desiredPills').innerHTML =
    items.map(n => `<button class="pill ${state.desired.has(n)?'on':''}" onclick="toggleDesired('${n}')">${n}</button>`).join('');
}
function toggleDesired(n){
  state.desired.has(n) ? state.desired.delete(n) : state.desired.add(n);
  renderDesiredPills(); refreshMatches();
}

/* ============ Desired Mood UI ============ */
function renderDesiredTabs(){
  $('#desiredTabs').innerHTML = Object.keys(MOOD_GROUPS).map(g =>
    `<button class="pill ${g===activeGroup?'on':''}" onclick="setDesiredGroup('${g}')">${g}</button>`).join('');
}
function setDesiredGroup(g){ activeGroup=g; renderDesiredTabs(); renderDesiredPills(); refreshMatches(); }
function renderDesiredPills(){
  const items = MOOD_GROUPS[activeGroup];
  $('#desiredPills').innerHTML = items.map(n =>
    `<button class="pill ${state.desired.has(n)?'on':''}" onclick="toggleDesired('${n}')">${n}</button>`).join('');
}
function toggleDesired(n){ state.desired.has(n)?state.desired.delete(n):state.desired.add(n); renderDesiredPills(); refreshMatches(); }

/* ============ Covers (Google Books + Open Library fallback) ============ */
async function prefetchCovers(){
  async function googleImg(b){
    const q = encodeURIComponent(`intitle:${b.title} inauthor:${b.author}`);
    const r = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);
    if(!r.ok) return null;
    const d = await r.json();
    const img = d?.items?.[0]?.volumeInfo?.imageLinks?.thumbnail
             || d?.items?.[0]?.volumeInfo?.imageLinks?.smallThumbnail;
    return img ? img.replace('http://','https://') : null;
  }
  async function openLibImg(b){
    const q = encodeURIComponent(b.title);
    const a = encodeURIComponent(b.author||'');
    const r = await fetch(`https://openlibrary.org/search.json?title=${q}&author=${a}&limit=1`);
    if(!r.ok) return null;
    const d = await r.json();
    const cid = d?.docs?.[0]?.cover_i;
    return cid ? `https://covers.openlibrary.org/b/id/${cid}-L.jpg` : null;
  }

  await Promise.all(BOOKS.map(async b=>{
    if (b.image) return;
    try { b.image = await googleImg(b); } catch(e){ b.image = null; }
    if(!b.image){
      try { b.image = await openLibImg(b); } catch(e){ /* keep null */ }
    }
  }));
}

/* ============ Scoring + render ============ */
function score(b){
  const inter=(arr,set)=>arr.filter(x=>set.has(x)).length;
  let s = inter(b.vibes||[], state.desired)*1.4;
  if(state.moodNowLevel==='Low') s += 0.2;
  if(state.moodNowLevel==='High') s += 0.1;
  if(b.gold) s += 2.5;
  return s;
}
function refreshMatches(){
  state.order = [...BOOKS].sort((a,b)=>score(b)-score(a));
  renderDeck();
}

/* ============ Carousel + per-card swipe ============ */

  // Bind swipe to each card
  box.querySelectorAll('.card-gesture').forEach(card=>{
    const id = card.getAttribute('data-id');
    addSwipe(card, ()=>markShelf(id,'want'), ()=>markShelf(id,'reading'));
    card.tabIndex=0;
    card.onkeydown = (e)=>{ if(e.key==='ArrowLeft') markShelf(id,'want'); if(e.key==='ArrowRight') markShelf(id,'reading'); };
  });
}

/* — Edge browse (no save) — */
function prevCard(){ const el=document.getElementById('carousel'); el.scrollBy({left:-window.innerWidth*0.8,behavior:'smooth'}); }
function nextCard(){ const el=document.getElementById('carousel'); el.scrollBy({left: window.innerWidth*0.8,behavior:'smooth'}); }

/* — Smooth, fast swipe — */
function addSwipe(el, onLeft, onRight){
  const THRESH_DIST = 60;
  const THRESH_VELO = 0.6;
  const ROT_FACTOR  = 15;
  const FLY_MS      = 220;

  let downX=0, downY=0, dx=0, dy=0, dragging=false;
  let lastX=0, lastT=0, vx=0;
  const like = el.querySelector('.badge-swipe.like');
  const nope = el.querySelector('.badge-swipe.nope');

  let raf = 0;
  const apply = () => {
    el.style.transform = `translate(${dx}px, ${dy}px) rotate(${dx/ROT_FACTOR}deg)`;
    const a = Math.min(1, Math.abs(dx)/120);
    if (dx > 0) { like.style.opacity = a; nope.style.opacity = 0; }
    else        { nope.style.opacity = a; like.style.opacity = 0; }
    raf = 0;
  };
  const update = () => { if (!raf) raf = requestAnimationFrame(apply); };

  const down = (e) => {
    dragging = true;
    el.style.transition = '';
    const p = e.touches ? e.touches[0] : e;
    downX = lastX = p.clientX; downY = p.clientY;
    dx = dy = 0; lastT = performance.now();
  };

  const move = (e) => {
    if (!dragging) return;
    const p = e.touches ? e.touches[0] : e;
    const t = performance.now();
    dx = p.clientX - downX;
    dy = p.clientY - downY;
    const dt = Math.max(1, t - lastT);
    vx = (p.clientX - lastX) / dt;
    lastX = p.clientX; lastT = t;
    update();
  };

  const flyOut = (dirRight) => {
    el.style.transition = `transform ${FLY_MS}ms ease-out`;
    const x = dirRight ? window.innerWidth : -window.innerWidth;
    el.style.transform = `translate(${x}px, -40px) rotate(${dirRight?20:-20}deg)`;
    setTimeout(dirRight ? onRight : onLeft, FLY_MS - 40);
    like.style.opacity = 0; nope.style.opacity = 0;
  };

  const snap = () => {
    el.style.transition = 'transform 180ms ease';
    el.style.transform  = 'translate(0,0) rotate(0)';
    like.style.opacity = 0; nope.style.opacity = 0;
  };

  const up = () => {
    if (!dragging) return;
    dragging = false;
    const fastFlick = Math.abs(vx) > THRESH_VELO;
    const farDrag   = Math.abs(dx) > THRESH_DIST;
    if (fastFlick || farDrag) flyOut(dx > 0);
    else snap();
  };

  el.addEventListener('pointerdown', down,  {passive:true});
  el.addEventListener('pointermove', move,  {passive:true});
  el.addEventListener('pointerup',   up,    {passive:true});
  el.addEventListener('pointercancel', up,  {passive:true});
  el.addEventListener('touchstart',  down,  {passive:true});
  el.addEventListener('touchmove',   move,  {passive:true});
  el.addEventListener('touchend',    up,    {passive:true});
}

/* ============ Shelf mini list ============ */
function markShelf(id,status){
  const b=BOOKS.find(x=>x.id===id); if(!b) return;
  const ex = state.shelf.find(x=>x.id===id);
  if(ex){ ex.status=status; ex.image=b.image||ex.image; }
  else { state.shelf.unshift({id:b.id,title:b.title,author:b.author,image:b.image,status}); }
  localStorage.setItem('bh_shelf',JSON.stringify(state.shelf));
  addPts(status==='want'?5:(status==='reading'?7:10));
  renderShelf();
}
function renderShelf(){
  const box=$('#shelfList'); if(!box) return;
  if(!state.shelf.length){ box.innerHTML=''; return; }
  box.innerHTML = state.shelf.map(b=>`
    <div class="tile">
      <div class="thumb">${b.image?`<img src="${b.image}" alt="">`:''}</div>
      <div><div><b>${escapeHtml(b.title)}</b></div><div class="muted">by ${escapeHtml(b.author)}</div></div>
      <div class="stat ${b.status}">${b.status}</div>
    </div>`).join('');
}
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('pts').textContent = state.pts + ' pts';
  document.getElementById('profilePts').textContent = state.pts;

  renderDesiredTabs();
  renderDesiredPills();

  await prefetchCovers();  // fetch covers if possible
  refreshMatches();        // builds the deck (uses images or letter fallback)

  renderShelf();
});
/* ============ Boot ============ */
document.addEventListener('DOMContentLoaded', async ()=>{
  $('#pts').textContent = state.pts + ' pts';
  try{ document.getElementById('profilePts').textContent = state.pts; }catch(e){}
  renderDesiredTabs(); renderDesiredPills();
  await prefetchCovers();   // pull covers where possible (Google + Open Library)
  refreshMatches();         // build carousel
  renderShelf();
});
  /* ===== Deck renderer (creates 3 stacked cards) ===== */
function renderDeck(){
  const box = document.getElementById('deck'); if(!box) return;
  const top3 = state.order.slice(0, 3);

  box.innerHTML = top3.map(b=>{
    const chips = [
      ...(b.vibes||[]),
      b.facts?.pace,
      b.facts?.pages?`${b.facts.pages}p`:null,
      b.facts?.year?`Since ${b.facts.year}`:null
    ].filter(Boolean);
    const chipsHtml = chips.map(c=>`<span class="chip">${escapeHtml(c)}</span>`).join('');
    const placeholder = escapeHtml(b.title?.[0]||'?');

    return `
      <article class="card-gesture" data-id="${b.id}">
        <div class="cover">${b.image?`<img src="${b.image}" alt="Cover of ${escapeHtml(b.title)}">`:placeholder}</div>
        <div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>${b.gold?'<span class="badge gold">Featured</span>':''}</div>
            <div class="badge gold">${state.pts} pts</div>
          </div>
          <div class="title">${escapeHtml(b.title)}</div>
          <div class="muted">by ${escapeHtml(b.author)}</div>
          <div class="chips">${chipsHtml}</div>
          <div class="actions">
            <button class="btn" onclick="markShelf('${b.id}','want')">Want (+5)</button>
            <button class="btn" onclick="markShelf('${b.id}','reading')">Reading (+7)</button>
            <button class="btn" style="background:#fff7cc;border-color:#d6bb00" onclick="markShelf('${b.id}','read')">Already read</button>
          </div>
        </div>
        <span class="badge-swipe like">SAVE</span>
        <span class="badge-swipe nope">NOPE</span>
      </article>`;
  }).join('');

  // Bind swipe to the top card only (others are passive)
  const topCard = box.querySelector('.card-gesture');
  if(topCard){
    const id = topCard.getAttribute('data-id');
    addDeckSwipe(topCard,
      ()=>onSwipe('left', id),
      ()=>onSwipe('right', id)
    );
    // desktop keys for quick testing
    topCard.tabIndex = 0;
    topCard.onkeydown = (e)=>{
      if(e.key==='ArrowLeft')  onSwipe('left', id);
      if(e.key==='ArrowRight') onSwipe('right', id);
    };
  }
}

/* When a swipe completes, save + rotate the deck */
function onSwipe(dir, id){
  if(dir==='left')  markShelf(id,'want');
  if(dir==='right') markShelf(id,'reading');

  // move the swiped book to end of the list
  const idx = state.order.findIndex(x=>x.id===id);
  if(idx>-1){
    const [b] = state.order.splice(idx,1);
    state.order.push(b);
  }
  renderDeck();
}

/* Smooth, fast swipe for deck (top card only) */
function addDeckSwipe(el, onLeft, onRight){
  const THRESH_DIST = 60, THRESH_VELO = 0.6, ROT_FACTOR = 15, FLY_MS = 220;
  let downX=0, downY=0, dx=0, dy=0, dragging=false, lastX=0, lastT=0, vx=0;
  const like = el.querySelector('.badge-swipe.like');
  const nope = el.querySelector('.badge-swipe.nope');
  let raf=0;

  const apply = ()=>{
    el.style.transform = `translate(${dx}px, ${dy}px) rotate(${dx/ROT_FACTOR}deg)`;
    const a = Math.min(1, Math.abs(dx)/120);
    if (dx > 0) { like.style.opacity = a; nope.style.opacity = 0; }
    else        { nope.style.opacity = a; like.style.opacity = 0; }
    raf=0;
  };
  const update = ()=>{ if(!raf) raf=requestAnimationFrame(apply); };

  const down = (e)=>{
    dragging=true; el.style.transition='';
    const p = e.touches?e.touches[0]:e;
    downX = lastX = p.clientX; downY = p.clientY; dx=dy=0; lastT = performance.now();
  };
  const move = (e)=>{
    if(!dragging) return;
    const p = e.touches?e.touches[0]:e; const t=performance.now();
    dx = p.clientX - downX; dy = p.clientY - downY;
    const dt = Math.max(1, t-lastT); vx = (p.clientX-lastX)/dt; lastX=p.clientX; lastT=t;
    update();
  };
  const fly = (right)=>{
    el.style.transition = `transform ${FLY_MS}ms ease-out`;
    const x = right ? window.innerWidth : -window.innerWidth;
    el.style.transform = `translate(${x}px, -40px) rotate(${right?20:-20}deg)`;
    setTimeout(()=> right?onRight():onLeft(), FLY_MS-40);
    like.style.opacity=0; nope.style.opacity=0;
  };
  const snap = ()=>{
    el.style.transition='transform 180ms ease';
    el.style.transform='translate(0,0) rotate(0)';
    like.style.opacity=0; nope.style.opacity=0;
  };
  const up = ()=>{
    if(!dragging) return; dragging=false;
    const fast = Math.abs(vx) > THRESH_VELO;
    const far  = Math.abs(dx) > THRESH_DIST;
    if(fast || far) fly(dx>0); else snap();
  };

  el.addEventListener('pointerdown',down,{passive:true});
  el.addEventListener('pointermove',move,{passive:true});
  el.addEventListener('pointerup',up,{passive:true});
  el.addEventListener('pointercancel',up,{passive:true});
  el.addEventListener('touchstart',down,{passive:true});
  el.addEventListener('touchmove',move,{passive:true});
  el.addEventListener('touchend',up,{passive:true});
}
</script>
</script>
</body>
</html>
